<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hoola (ÌõåÎùº) ‚Äî ÎÑ§Ïò® 3D ÏïÑÎ†àÎÇò</title>
  <style>
    :root{
      --bg:#050712;
      --ink:#e6ebff;
      --ink-soft:rgba(198,206,255,.75);
      --muted:#7a89c9;
      --primary:#6b92ff;
      --accent:#ff82d3;
      --ok:#8be28b;
      --warn:#ffc66b;
      --danger:#ff7b8a;
      --card:#111831;
      --card-face:#1c2340;
      --shadow:0 20px 36px rgba(6,9,28,.55);
      --radius:20px;
      --seat-glow:0 18px 42px rgba(103,132,255,.55);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Pretendard",ui-rounded,system-ui,Segoe UI,Apple SD Gothic Neo,Roboto,sans-serif;
      background:
        radial-gradient(1200px 620px at 5% -10%, rgba(77,102,255,.35) 0%, transparent 60%),
        radial-gradient(800px 520px at 95% -20%, rgba(255,130,211,.28) 0%, transparent 70%),
        linear-gradient(180deg,#050712 0%, #0a0f24 70%, #04030b 100%);
      color:var(--ink);
    }
    .app{display:grid;grid-template-rows:auto 1fr auto; gap:16px; height:100%; max-width:1320px; margin:0 auto; padding:20px}
    header{display:flex; align-items:center; justify-content:space-between; gap:16px}
    header h1{font-size:20px;margin:0;font-weight:800;letter-spacing:.6px;text-transform:uppercase;color:#fff;text-shadow:0 0 18px rgba(107,146,255,.55)}
    header .opts{display:flex; gap:12px; align-items:center; color:var(--ink-soft); flex-wrap:wrap}
    header .opts label{display:flex; align-items:center; gap:6px; background:rgba(14,21,45,.6); padding:8px 12px; border-radius:14px; border:1px solid rgba(115,140,255,.22)}
    header .opts select{background:rgba(9,14,30,.8); border:1px solid rgba(115,140,255,.4); border-radius:10px; padding:6px 26px 6px 10px; color:var(--ink); font-weight:600}
    header .opts select:disabled{opacity:.5}
    header .opts .badge{background:rgba(15,20,44,.9); color:var(--ink-soft)}
    .board{display:grid; grid-template-columns:minmax(0,1fr) 320px; gap:20px; height:100%}
    .table{position:relative; display:flex; flex-direction:column; gap:22px; overflow:visible}
    .arena{position:relative; border-radius:36px; padding:34px; background:radial-gradient(circle at 50% 30%, rgba(107,146,255,.35) 0%, rgba(35,47,105,.6) 45%, rgba(8,10,25,.9) 100%); box-shadow:0 40px 80px rgba(5,9,35,.55), inset 0 0 0 1px rgba(129,149,255,.2);}
    .arena-stage{position:relative; width:100%; aspect-ratio:4/3; margin:0 auto; perspective:1600px; transform-style:preserve-3d}
    .arena-surface{position:absolute; inset:0; border-radius:46px; background:linear-gradient(135deg, rgba(25,32,72,.95) 0%, rgba(9,13,34,.92) 50%, rgba(19,28,66,.95) 100%); transform:rotateX(58deg); transform-style:preserve-3d; box-shadow:inset 0 24px 60px rgba(18,27,76,.65), inset 0 -32px 40px rgba(5,7,18,.95), 0 60px 140px rgba(4,6,18,.75)}
    .arena-surface::after{content:""; position:absolute; inset:-24px; border-radius:56px; background:radial-gradient(circle at 50% 0%, rgba(103,132,255,.45), transparent 60%); opacity:.65; filter:blur(28px); pointer-events:none}
    .arena .zones{position:absolute; inset:12% 14%; display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:18px; transform-style:preserve-3d; transform:translateZ(120px)}
    .arena .zone{background:linear-gradient(180deg, rgba(26,36,84,.92) 0%, rgba(18,24,60,.88) 100%); border-radius:20px; border:1px solid rgba(142,162,255,.25); box-shadow:0 28px 45px rgba(2,4,14,.55), inset 0 8px 16px rgba(120,142,255,.15); padding:12px; min-height:120px; display:flex; flex-direction:column; gap:10px; color:var(--ink)}
    .zone h3{margin:0; font-size:12px; letter-spacing:.6px; text-transform:uppercase; color:rgba(198,206,255,.75)}
    .seat-layer{position:absolute; inset:0; transform-style:preserve-3d; pointer-events:none; --orbit:48%;}
    .seat{position:absolute; left:50%; top:50%; width:148px; transform:rotateZ(var(--angle)) translateY(calc(-1 * var(--orbit))) rotateZ(calc(var(--angle) * -1)) translateZ(140px); transform-origin:center; display:flex; flex-direction:column; align-items:center; gap:4px; padding:12px 14px; border-radius:16px; background:rgba(12,17,39,.92); color:#f8f9ff; box-shadow:0 18px 42px rgba(6,9,24,.55); border:1px solid rgba(122,150,255,.3); text-shadow:0 0 8px rgba(107,146,255,.6); transition:transform .35s ease, box-shadow .35s ease, opacity .35s ease}
    .seat[data-turn="true"]{background:linear-gradient(180deg, rgba(108,149,255,.95) 0%, rgba(73,105,255,.95) 100%); box-shadow:var(--seat-glow); color:#060b21}
    .seat[data-status="out"]{opacity:.4; text-shadow:none}
    .seat .seat-name{font-weight:700; font-size:14px}
    .seat .seat-meta{font-size:12px; opacity:.85}
    .seat[data-bot="true"] .seat-name::after{content:"ü§ñ"; margin-left:6px}
    .seat[data-bot="false"] .seat-name::after{content:"üôÇ"; margin-left:6px}
    .seat[data-turn="true"] .seat-name::after{content:"üî•"; margin-left:6px}
    .seat-layer::after{content:""; position:absolute; inset:8%; border-radius:50%; border:1px dashed rgba(128,150,255,.28); transform:translateZ(80px)}
    .right{display:flex; flex-direction:column; gap:16px}
    .panel{background:rgba(12,17,40,.85); border-radius:22px; box-shadow:0 20px 36px rgba(4,7,20,.6); padding:16px; border:1px solid rgba(114,138,255,.18); color:var(--ink)}
    .panel strong{color:#fff; letter-spacing:.3px}
    .panel small{color:var(--ink-soft)}
    .table-panels{display:flex; flex-direction:column; gap:16px}
    .panel.hand{position:sticky; bottom:0; background:linear-gradient(180deg, rgba(16,22,47,.95) 0%, rgba(10,14,32,.92) 100%)}
    .hud{display:flex; flex-wrap:wrap; gap:10px}
    button{appearance:none; border:none; background:linear-gradient(180deg,#3d4fff,#2836ff); color:#fff; padding:10px 14px; border-radius:14px; font-weight:700; cursor:pointer; box-shadow:0 14px 28px rgba(39,51,158,.5); letter-spacing:.2px}
    button.ghost{background:rgba(16,24,58,.85); color:var(--ink); border:1px solid rgba(115,140,255,.4); box-shadow:none}
    button:disabled{opacity:.4; cursor:not-allowed; box-shadow:none}
    .badge{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:rgba(12,18,42,.75); box-shadow:0 10px 20px rgba(4,6,14,.45); font-size:12px; color:var(--ink-soft)}
    .board .badge{background:rgba(18,25,60,.8)}
    .zones .cards{display:flex; align-items:flex-end; flex-wrap:wrap; gap:8px}
    .card{width:70px; height:98px; border-radius:18px; background:var(--card); box-shadow:0 18px 30px rgba(2,4,14,.65); position:relative; transform:translateZ(0); transition:.25s transform, .25s box-shadow, .25s opacity; cursor:pointer; user-select:none; border:1px solid rgba(120,146,255,.18)}
    .card::before{content:""; position:absolute; inset:0; border-radius:inherit; background:linear-gradient(135deg, rgba(255,255,255,.12), transparent 60%); opacity:.8; mix-blend-mode:screen}
    .card:hover{transform:translateY(-10px) rotateX(6deg) rotateZ(-1deg); box-shadow:0 24px 45px rgba(2,4,14,.75)}
    .card .inner{position:absolute; inset:0; border-radius:inherit; display:grid; place-items:center; padding:8px; background:var(--card-face)}
    .rank{font-weight:900; font-size:22px}
    .suit{font-size:18px}
    .red{color:#ff8b9d} .black{color:#90a2ff}
    .selected{outline:3px solid var(--accent); outline-offset:0}
    .disabled{opacity:.45; pointer-events:none}
    .meld{padding:12px; border-radius:18px; background:linear-gradient(180deg, rgba(30,38,88,.9), rgba(14,20,44,.88)); box-shadow:0 18px 30px rgba(4,6,18,.55); border:1px solid rgba(115,138,255,.25); animation:pop .25s ease}
    .meld .cards{gap:-46px}
    .meld .card{transform:rotate(0)}
    .log{font-size:12px; color:var(--ink-soft); max-height:160px; overflow:auto}
    .rankpill{display:inline-block;background:rgba(78,102,215,.25);color:#aebcff;padding:4px 10px;border-radius:999px;font-weight:700}
    .toast{position:fixed; right:16px; bottom:16px; background:#111827; color:#fff; padding:12px 16px; border-radius:14px; opacity:.95; animation:slideup .25s ease; box-shadow:0 18px 34px rgba(4,6,18,.6)}
    .pill{display:inline-block; padding:3px 8px; border-radius:999px; background:#313c7a; color:#bfc9ff; font-weight:700}

    /* layout helpers */
    .cards{display:flex; align-items:flex-end; flex-wrap:wrap; gap:10px}
    .hand .cards{justify-content:center}
    .zone .hud{justify-content:space-between}
    .panel-title{margin:0 0 10px 0; color:var(--ink-soft); font-size:13px; letter-spacing:.4px}
    .hand-header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px}
    .hand-header h3{margin:0; color:var(--ink); letter-spacing:.4px}
    .panel.hand .hud{justify-content:flex-end}
    .panel.hand .hud button{flex:1 1 auto; min-width:118px}
    .meld-grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:14px}
    .panel .hud button{flex:1 1 auto}
    .panel .hud button.ghost{border-color:rgba(131,151,255,.5)}

    .panel-head{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:12px}
    #deckCount{display:flex; align-items:center; justify-content:center; font-weight:700; font-size:16px; color:#fff}
    #discardCards{min-height:60px}
    .button-row{display:flex; gap:10px; flex-wrap:wrap}
    .button-row button{flex:1 1 auto}
    .button-row .badge{flex:0 0 auto}
    .net-io{display:flex; flex-direction:column; gap:8px; margin-top:10px}
    textarea{background:rgba(10,15,32,.9); border:1px solid rgba(120,140,255,.35); border-radius:14px; padding:10px; color:var(--ink); width:100%; min-height:80px; resize:vertical; font-family:inherit}
    textarea[readonly]{opacity:.7}
    button.danger{background:linear-gradient(180deg,#ff7b8a,#ff4d6b); box-shadow:0 16px 28px rgba(255,77,121,.4)}
    .player-line{display:flex; align-items:center; justify-content:space-between; gap:8px; margin:6px 0; padding:8px 12px; border-radius:12px; background:rgba(18,24,58,.45); border:1px solid rgba(112,134,255,.18); color:var(--ink-soft)}
    .player-name{display:flex; align-items:center; gap:6px}
    .player-type{font-size:16px; color:#fff}
    .player-line[data-turn="true"]{background:rgba(105,138,255,.25); border-color:rgba(155,176,255,.55); color:#fff}
    .player-line[data-status="out"]{opacity:.45}
    .player-line .rankpill{background:rgba(96,118,255,.25); color:#d7deff}
    footer{display:flex; align-items:center; justify-content:space-between; gap:12px; color:var(--ink-soft); background:rgba(10,14,32,.85); padding:14px 20px; border-radius:20px; border:1px solid rgba(120,140,255,.2); box-shadow:0 20px 34px rgba(3,5,18,.5); margin-top:8px}
    footer button{min-width:120px}

    @media (max-width: 1180px){
      .seat-layer{--orbit:44%}
      .seat{width:132px}
    }

    @media (max-width: 1024px){
      .app{padding:16px; gap:14px}
      header{flex-direction:column; align-items:flex-start}
      header .opts{width:100%; justify-content:flex-start}
      .board{grid-template-columns:minmax(0,1fr); grid-template-rows:auto auto; gap:18px}
      .right{order:-1}
      .arena{padding:26px}
      .arena-stage{aspect-ratio:5/4}
      .arena-surface{transform:rotateX(54deg)}
      .seat-layer{--orbit:42%}
    }

    @media (max-width: 780px){
      header h1{text-align:center; width:100%; font-size:18px}
      header .opts{flex-direction:column; align-items:stretch}
      header .opts label{width:100%}
      .board{gap:14px}
      .arena{padding:18px}
      .arena-stage{aspect-ratio:1.1}
      .arena-surface{transform:rotateX(48deg)}
      .seat{width:122px; padding:10px 12px}
      .seat-layer{--orbit:40%}
      .panel.hand .hud{flex-wrap:wrap; justify-content:center}
      .panel.hand .hud button{flex:1 1 calc(50% - 8px); min-width:0}
    }

    @media (max-width: 540px){
      .app{padding:12px}
      .arena{padding:16px}
      .seat-layer{display:none}
      .arena-surface{transform:rotateX(42deg)}
      .cards{justify-content:center}
    }
    /* animations */
    @keyframes slideup{from{transform:translateY(12px); opacity:0} to{transform:translateY(0); opacity:1}}
    @keyframes pop{from{transform:scale(.96)} to{transform:scale(1)}}
    @keyframes drop{from{transform:translateY(-10px); opacity:.6} to{transform:translateY(0); opacity:1}}
    @keyframes pulse{from{transform:translateY(0);} to{transform:translateY(-4px);}}
    .pulse{animation:pulse .8s ease-in-out infinite alternate}
    .enter{animation:drop .2s ease}

    /* fly animations */
    .flycard{position:fixed; pointer-events:none; z-index:9999; width:70px; height:98px; border-radius:16px; background:#fff; box-shadow:var(--shadow); display:grid; place-items:center; transition:transform .28s ease, opacity .28s ease}
    .flyrank{font-weight:900; font-size:22px}
    .flysuit{font-size:18px}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Hoola ¬∑ ÎÑ§Ïò® 3D Arena</h1>
      <div class="opts">
        <label><input type="checkbox" id="opt-continue" /> <span>ÏïÑÏõÉ ÌõÑ Í≥ÑÏÜç(ÏàúÏúÑ ÌôïÏ†ï)</span></label>
        <label>
          <span>ÌîåÎ†àÏù¥Ïñ¥ Ïàò</span>
          <select id="opt-seats">
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
          </select>
        </label>
        <span class="badge" id="turnBadge">ÌÑ¥: -</span>
      </div>
    </header>

    <div class="board">
      <div class="table" id="table">
        <div class="arena" id="arena">
          <div class="arena-stage">
            <div class="arena-surface">
              <div class="zones">
                <div class="zone" id="deckZone">
                  <h3>DECK</h3>
                  <div class="cards" id="deckCount"></div>
                  <div class="hud"><button id="btnDraw">ÎìúÎ°úÏö∞</button><button id="btnTY" class="ghost">Îï°ÌÅê</button></div>
                </div>
                <div class="zone" id="discardZone">
                  <h3>DISCARD</h3>
                  <div class="cards" id="discardCards"></div>
                </div>
                <div class="zone" id="infoZone">
                  <h3>INFO</h3>
                  <div class="log" id="log"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="seat-layer" id="arenaSeats"></div>
        </div>

        <div class="table-panels">
          <div class="panel">
            <h3 class="panel-title">TABLE MELDS</h3>
            <div id="melds" class="meld-grid"></div>
          </div>
          <div class="panel hand">
            <div class="hand-header">
              <h3>YOUR HAND</h3>
              <div class="hud">
                <button id="btnRegSet" class="ghost">ÏÑ∏Ìä∏ Îì±Î°ù</button>
                <button id="btnRegRun" class="ghost">Îü∞ Îì±Î°ù</button>
                <button id="btnAttach" class="ghost">Î∂ôÏù¥Í∏∞</button>
                <button id="btnDiscard" class="danger" disabled>Î≤ÑÎ¶¨Í≥† Ï¢ÖÎ£å</button>
              </div>
            </div>
            <div class="cards" id="hand"></div>
          </div>
        </div>
      </div>

      <aside class="right">
        <div class="panel">
          <div class="panel-head">
            <strong>Players</strong>
            <span class="pill" id="roundInfo">R1</span>
          </div>
          <div id="players"></div>
        </div>
        <div class="panel">
          <div class="panel-head">
            <strong>Finish Order</strong>
          </div>
          <ol id="finish"></ol>
        </div>
        <div class="panel">
          <div class="panel-head">
            <strong>Ïò®ÎùºÏù∏ ÌîåÎ†àÏù¥(Î≤†ÌÉÄ)</strong>
          </div>
          <div class="button-row">
            <button id="btnHost" class="ghost">Ìò∏Ïä§Ìä∏</button>
            <button id="btnJoin" class="ghost">Í≤åÏä§Ìä∏</button>
          </div>
          <small>SDP ÏΩîÎìúÎ•º Î≥µÏÇ¨/Î∂ôÏó¨ÎÑ£Í∏∞Î°ú Ïó∞Í≤∞Ìï©ÎãàÎã§(ÏÑúÎ≤Ñ ÏóÜÏù¥ P2P).</small>
          <div class="net-io">
            <textarea id="sdpIn" placeholder="ÏÉÅÎåÄ ÏΩîÎìú Î∂ôÏó¨ÎÑ£Í∏∞"></textarea>
            <textarea id="sdpOut" placeholder="ÎÇ¥ ÏΩîÎìú" readonly></textarea>
            <div class="button-row">
              <button id="btnApply" class="ghost">ÏΩîÎìú Ï†ÅÏö©</button>
              <span class="badge" id="netBadge">Ïò§ÌîÑÎùºÏù∏</span>
            </div>
          </div>
        </div>
      </aside>
    </div>

    <footer>
      <div>ÏµúÏÜå 3Î™Ö ¬∑ ÏµúÎåÄ 6Î™Ö ¬∑ Î∂ÄÏ°± Ïãú Î¥á ÏûêÎèô Ï∂©Ïõê ¬∑ Í∑úÏπô: ÎìúÎ°úÏö∞/Îï°ÌÅê ‚Üí Îì±Î°ù/Î∂ôÏù¥Í∏∞ ‚Üí Î≤ÑÎ¶¨Í∏∞</div>
      <button id="btnReset" class="ghost">ÏÉà Í≤åÏûÑ</button>
    </footer>
  </div>

  <div class="toast" id="toast" style="display:none"></div>

<script>
// ====== Card / Deck utils ======
const SUITS = ['‚ô†','‚ô•','‚ô¶','‚ô£'];
const RANKS = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
const isRed = s => s==='‚ô•' || s==='‚ô¶';

function buildDeck(){
  const deck=[]; let id=0;
  for(const s of SUITS){ for(const r of RANKS){ deck.push({ id: String(id++), suit: s, rank: r }); } }
  return shuffle(deck);
}
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
function rankValue(r){ if(r==='A') return 1; if(r==='J') return 11; if(r==='Q') return 12; if(r==='K') return 13; return parseInt(r,10); }
function sortByRank(cards){ return [...cards].sort((a,b)=>rankValue(a.rank)-rankValue(b.rank)); }

const MIN_PLAYERS = 3;
const MAX_PLAYERS = 6;
const BOT_NAMES = ['Î¥á ÎùºÎùº','Î¥á Ïø†Î£®','Î¥á ÌîºÌîº','Î¥á Î™®Î™®','Î¥á ÎÑ§Ïò§','Î¥á ÏßÄÏßÄ','Î¥á ÌÜ†ÌÜ†','Î¥á Î£®Î£®'];

function clampSeatCount(n){
  const num = Number(n);
  if(Number.isNaN(num)) return MIN_PLAYERS;
  return Math.min(MAX_PLAYERS, Math.max(MIN_PLAYERS, Math.round(num)));
}

function botNameFor(index){
  const base = BOT_NAMES[index % BOT_NAMES.length];
  const suffix = index >= BOT_NAMES.length ? ` ${Math.floor(index / BOT_NAMES.length) + 1}` : '';
  return base + suffix;
}

function createPlayer(id, name, isBot){
  return { id, name, isBot, hand:[], status:'active' };
}

// ====== Meld validation ======
function isSet(cards){ if(cards.length<3) return false; const r = cards[0].rank; return cards.every(c=>c.rank===r); }
function isRun(cards){
  if(cards.length<3) return false; const suit=cards[0].suit; if(!cards.every(c=>c.suit===suit)) return false;
  const sorted = sortByRank(cards);
  let ok = true; for(let i=1;i<sorted.length;i++){ if(rankValue(sorted[i].rank)!==rankValue(sorted[i-1].rank)+1) { ok=false; break; } }
  if(ok) return true;
  const mapHigh = x=> x.rank==='A'?14:rankValue(x.rank);
  const s2 = [...cards].sort((a,b)=>mapHigh(a)-mapHigh(b));
  ok=true; for(let i=1;i<s2.length;i++){ if(mapHigh(s2[i])!==mapHigh(s2[i-1])+1){ ok=false; break; } }
  return ok;
}
function canAttach(card, meld){
  if(meld.kind==='seven') return false; // 7 Îã®ÎèÖ Îì±Î°ùÏóêÎäî Î∂ôÏùº Ïàò ÏóÜÏùå
  if(meld.kind==='set'){
    const cs = [...meld.cards, card];
    return isSet(cs);
  }
  if(meld.kind==='run'){
    return canAttachRunEnds(card, meld.cards);
  }
  return false;
}
function canAttachRunEnds(card, runCards){
  // Î∂ôÏù¥Í∏∞Îäî "Ïñë ÎÅù"ÏóêÎßå ÌóàÏö©. Ï§ëÍ∞Ñ ÏÇΩÏûÖ Í∏àÏßÄ.
  if(runCards.length<3) return false;
  const suit = runCards[0].suit;
  if(!runCards.every(c=>c.suit===suit)) return false;
  if(card.suit!==suit) return false;
  const mapLow = x=> rankValue(x.rank);
  const mapHigh = x=> x.rank==='A'?14:rankValue(x.rank);
  const numsLow = [...runCards].map(mapLow).sort((a,b)=>a-b);
  const numsHigh = [...runCards].map(mapHigh).sort((a,b)=>a-b);
  const isConsecutive = (arr)=> arr.every((v,i)=> i===0 || v===arr[i-1]+1);
  let allow=false;
  const vLow = mapLow(card);
  const vHigh = mapHigh(card);
  if(isConsecutive(numsLow)){
    const lowMin = numsLow[0], lowMax = numsLow[numsLow.length-1];
    if(vLow===lowMin-1 || vLow===lowMax+1) allow=true;
  }
  if(!allow && isConsecutive(numsHigh)){
    const hiMin = numsHigh[0], hiMax = numsHigh[numsHigh.length-1];
    if(vHigh===hiMin-1 || vHigh===hiMax+1) allow=true;
  }
  return allow && isRun([...runCards, card]);
}
function classifyMeld(cards){
  if(cards.length===1 && cards[0].rank==='7') return { kind:'seven', cards:[...cards] };
  if(isSet(cards)) return { kind:'set', cards: sortByRank(cards) };
  if(isRun(cards)) return { kind:'run', cards: sortByRank(cards) };
  return null;
}

// ====== State ======
const state = {
  deck: [],
  discard: [],
  melds: [],
  players: [],
  turnIndex: 0,
  phase: 'choose-source', // choose-source | action | gameover
  finishOrder: [],
  options: { continueAfterOut: true, totalSeats: 4 },
  round: 1,
  mustUseThankYouCardId: null,
  ty: { open:false, claimant:null, fromPlayerId:null, cardId:null }, // Îï°ÌÅê ÏÑ†Ï∞©Ïàú ÎùΩ
};

function newGame(){
  state.deck = buildDeck();
  state.discard = [];
  state.melds = [];
  state.options.totalSeats = clampSeatCount(state.options.totalSeats ?? MIN_PLAYERS);
  const seats = state.options.totalSeats;
  const roster = [];
  const youLabel = net.online ? (net.isHost ? 'You(Host)' : 'You') : 'You';
  roster.push(createPlayer('P1', youLabel, false));
  if(net.online){
    roster.push(createPlayer('P2', net.isHost ? 'Guest' : 'Host', false));
  }
  let botIndex = 0;
  while(roster.length < seats){
    const id = `P${roster.length+1}`;
    roster.push(createPlayer(id, botNameFor(botIndex++), true));
  }
  state.players = roster;
  state.turnIndex = 0;
  state.phase='choose-source';
  state.finishOrder=[];
  state.round=1;
  state.mustUseThankYouCardId=null;
  state.ty={open:false, claimant:null, fromPlayerId:null, cardId:null};
  for(let i=0;i<7;i++) state.players.forEach(p=>p.hand.push(state.deck.pop()));
  if(state.deck.length){ state.discard.push(state.deck.pop()); }
  clearSelection();
  drawUI();
  logMsg(`Í≤åÏûÑ ÏãúÏûë! (${state.players.length}Ïù∏ ÌÖåÏù¥Î∏î)`);
  maybeBotTurn();
}

function current(){ return state.players[state.turnIndex]; }
function nextActiveIndex(from){ const n=state.players.length; for(let k=1;k<=n;k++){ const idx=(from+k)%n; if(state.players[idx].status==='active') return idx; } return from; }

// ====== Rules helpers ======
function legalThankYouFor(player){
  const top = state.discard[state.discard.length-1]; if(!top) return {allowed:false};
  if(!state.ty.open) return {allowed:false};
  // Î≥∏Ïù∏Ïù¥ Î∞©Í∏à Î≤ÑÎ¶∞ Ïπ¥ÎìúÎäî Îï°ÌÅê Î∂àÍ∞Ä
  if(state.ty.fromPlayerId===player.id) return {allowed:false};
  // ÎìúÎ°úÏö∞/Îï°ÌÅê Ï§ëÎ≥µ Í∏àÏßÄ: ÌòÑÏû¨ ÌÑ¥Ïùò phaseÍ∞Ä choose-sourceÍ∞Ä ÏïÑÎãàÏñ¥ÎèÑ, Îï°ÌÅêÎäî Ïù∏ÌÑ∞ÎüΩÌä∏Î°ú ÌóàÏö©ÌïòÏßÄÎßå Ï¶âÏãú ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Í≤ΩÏö∞Îßå
  // Îì±Î°ù/Î∂ôÏù¥Í∏∞ Í∞ÄÎä• Ïó¨Î∂Ä Í≤ÄÏÇ¨
  // ÌÖåÏù¥Î∏î Î∂ôÏù¥Í∏∞ Ï≤¥ÌÅ¨
  for(let i=0;i<state.melds.length;i++){ if(canAttach(top, state.melds[i])) return {allowed:true, card:top, mode:'attach'}; }
  // Îì±Î°ù Ï≤¥ÌÅ¨ (7 Îã®ÎèÖ Ìè¨Ìï®)
  const trial = [...player.hand, top];
  const combos = kComb(trial, 1, 5);
  for(const c of combos){ const m=classifyMeld(c); if(m && c.some(x=>x.id===top.id)) return {allowed:true, card:top, mode:'register'}; }
  return {allowed:false};
}

function kComb(arr, minK=3, maxK=5){
  const res=[]; const n=arr.length; const max=Math.min(maxK,n);
  function rec(start, combo){
    if(combo.length>=minK) res.push([...combo]);
    if(combo.length===max) return;
    for(let i=start;i<n;i++){ combo.push(arr[i]); rec(i+1, combo); combo.pop(); }
  }
  rec(0,[]); return res;
}

function afterAnyAction(player){
  if(player.status==='active' && player.hand.length===0){
    player.status='out'; state.finishOrder.push(player.id);
    showToast(`${player.name} ÏïÑÏõÉ!`);
    state.mustUseThankYouCardId=null;
    state.ty={open:false, claimant:null, fromPlayerId:null, cardId:null};
    if(!state.options.continueAfterOut){ state.phase='gameover'; drawUI(); return true; }
    const left = state.players.filter(p=>p.status==='active').length;
    if(left<=1){
      const last = state.players.find(p=>p.status==='active');
      if(last){ last.status='out'; state.finishOrder.push(last.id); }
      state.phase='gameover'; drawUI(); return true;
    }
    const idxNow = state.turnIndex;
    if(state.players[idxNow].id===player.id){ state.turnIndex = nextActiveIndex(idxNow); state.phase='choose-source'; }
  }
  return false;
}

function endTurn(){
  state.turnIndex = nextActiveIndex(state.turnIndex);
  state.phase='choose-source';
  state.mustUseThankYouCardId=null;
  // ÌÑ¥ ÎÑòÏñ¥Í∞ÄÎ©¥ Îï°ÌÅê Ï∞Ω Îã´Ìûò(ÏÑ†Ï∞©Ïàú Ï∞ΩÏùÄ Î≤ÑÎ¶∞ ÏßÅÌõÑÏóêÎßå)
  state.ty={open:false, claimant:null, fromPlayerId:null, cardId:null};
}

// ====== Actions ======
function drawFromDeck(){
  const p=current(); if(state.phase!=='choose-source') return;
  if(state.deck.length===0){ reshuffleFromDiscard(); }
  if(state.deck.length===0) { logMsg('Îç± Í≥†Í∞à!'); return; }
  const fromRect = document.getElementById('deckZone').getBoundingClientRect();
  const newCard = state.deck.pop();
  p.hand.push(newCard);
  state.phase='action';
  // ÎìúÎ°úÏö∞Ìïú ÏàúÍ∞ÑÏóêÎäî Îï°ÌÅê Ï∞Ω Îã´Ïùå (ÎìúÎ°úÏö∞Î•º ÏÑ†ÌÉùÌñàÏúºÎØÄÎ°ú)
  state.ty.open=false;
  drawUI();
  const targetEl = document.querySelector(`#hand .card[data-id="${newCard.id}"]`);
  if(targetEl){ const toRect = targetEl.getBoundingClientRect(); flyCard(fromRect, toRect, newCard); }
}

function claimThankYou(playerIndex){
  const player = state.players[playerIndex];
  const chk = legalThankYouFor(player); if(!chk.allowed) return false;
  if(!state.ty.open) return false;
  if(state.ty.claimant && state.ty.claimant!==player.id) return false; // Ïù¥ÎØ∏ Îã§Î•∏ ÏÇ¨ÎûåÏù¥ Î®πÏùå
  // ÏÑ†Ï∞©Ïàú ÏßëÌñâ
  state.ty.claimant = player.id;
  const topEl = document.querySelector('#discardCards .card');
  const fromRect = topEl? topEl.getBoundingClientRect() : document.getElementById('discardZone').getBoundingClientRect();
  const top=state.discard.pop(); player.hand.push(top);
  state.mustUseThankYouCardId = top.id; // Î∞òÎìúÏãú Ï¶âÏãú ÏÇ¨Ïö©
  state.phase = (playerIndex===state.turnIndex) ? 'action' : state.phase; // Ïù∏ÌÑ∞ÎüΩÌä∏ÏßÄÎßå ÏûêÏã†Ïùò phase Í∞ïÏ†úÌïòÏßÑ ÏïäÏùå
  showToast(`Îï°ÌÅê! ${player.name} ÏÑ†Ï†ê ‚úÖ`);
  drawUI();
  const targetEl = document.querySelector(`#hand .card[data-id="${top.id}"]`);
  if(targetEl){ const toRect = targetEl.getBoundingClientRect(); flyCard(fromRect, toRect, top); }
  // Îï°ÌÅê Ï∞Ω Îã´Ïùå(ÏÑ†Ï∞©Ïàú)
  state.ty.open=false;
  return true;
}

function takeThankYou(){ // UIÏóêÏÑú ÎÇ¥ ÏûÖÏû•(0Î≤à ÌîåÎ†àÏù¥Ïñ¥)
  claimThankYou(0);
}

function registerSelected(kind){
  const p=current(); if(state.phase==='choose-source'){ showToast('Î®ºÏ†Ä ÎìúÎ°úÏö∞ ÎòêÎäî Îï°ÌÅê'); return; }
  const sel = selectedFromHand(); if(sel.length<1){ showToast('Ïπ¥ÎìúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî'); return; }
  if(state.mustUseThankYouCardId && !sel.some(c=>c.id===state.mustUseThankYouCardId)){
    showToast('Îï°ÌÅê Ïπ¥ÎìúÎ∂ÄÌÑ∞ ÏÇ¨Ïö©Ìï¥Ïïº Ìï¥Ïöî'); return;
  }
  const m = classifyMeld(sel);
  if(!m){ showToast('Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ Ï°∞Ìï©'); return; }
  if(kind==='set' && m.kind!=='set') { showToast('ÏÑ∏Ìä∏ ÏïÑÎãò'); return; }
  if(kind==='run' && m.kind!=='run') { showToast('Îü∞ ÏïÑÎãò'); return; }
  if(m.kind==='seven' || kind===undefined || kind===m.kind){
    p.hand = p.hand.filter(c=>!sel.includes(c));
    state.melds.push(m);
    logMsg(`${p.name} Îì±Î°ù: ${m.kind.toUpperCase()} (${pretty(m.cards)})`);
    if(state.mustUseThankYouCardId && sel.some(c=>c.id===state.mustUseThankYouCardId)) state.mustUseThankYouCardId=null;
    clearSelection(); drawUI(); if(afterAnyAction(p)) return; return;
  }
  showToast('ÏöîÏ≤≠Ìïú Ï¢ÖÎ•òÏôÄ ÏùºÏπòÌïòÏßÄ ÏïäÏùå');
}

function attachSelected(){
  const p=current(); if(state.phase==='choose-source'){ showToast('Î®ºÏ†Ä ÎìúÎ°úÏö∞ ÎòêÎäî Îï°ÌÅê'); return; }
  const sel = selectedFromHand(); if(sel.length!==1){ showToast('Î∂ôÏù¥Í∏∞Îäî 1Ïû•Îßå ÏÑ†ÌÉù'); return; }
  const card=sel[0];
  if(state.mustUseThankYouCardId && card.id!==state.mustUseThankYouCardId){ showToast('Îï°ÌÅê Ïπ¥ÎìúÎ∂ÄÌÑ∞ ÏÇ¨Ïö©Ìï¥Ïïº Ìï¥Ïöî'); return; }
  for(let i=0;i<state.melds.length;i++){
    const m=state.melds[i]; if(canAttach(card,m)){
      p.hand = p.hand.filter(c=>c!==card); m.cards.push(card); m.cards = sortByRank(m.cards);
      logMsg(`${p.name} Î∂ôÏù¥Í∏∞: ${card.rank}${card.suit} ‚Üí #${i+1}`);
      if(state.mustUseThankYouCardId===card.id) state.mustUseThankYouCardId=null;
      drawUI(); afterAnyAction(p); return;
    }
  }
  showToast('Î∂ôÏùº Ïàò ÏûàÎäî Í≥≥Ïù¥ ÏóÜÏñ¥Ïöî');
}

let pendingDiscard=null;
function setDiscard(){
  const p=current(); if(state.phase==='choose-source'){ showToast('Î®ºÏ†Ä ÎìúÎ°úÏö∞ ÎòêÎäî Îï°ÌÅê'); return; }
  if(state.mustUseThankYouCardId){ showToast('Îï°ÌÅê Ïπ¥Îìú Î®ºÏ†Ä ÏÇ¨Ïö©Ìï¥Ïïº Î≤ÑÎ¶¥ Ïàò ÏûàÏñ¥Ïöî'); return; }
  const sel = selectedFromHand(); if(sel.length!==1){ showToast('Î≤ÑÎ¶¨Í∏∞Îäî 1Ïû• ÏÑ†ÌÉù'); return; }
  pendingDiscard = sel[0];
  document.getElementById('btnDiscard').disabled=false;
  drawUI();
}
function commitDiscard(){
  const p=current();
  if(state.mustUseThankYouCardId){ showToast('Îï°ÌÅê Ïπ¥Îìú Î®ºÏ†Ä ÏÇ¨Ïö©!'); return; }
  if(!pendingDiscard){ const sel=selectedFromHand(); if(sel.length===1) pendingDiscard=sel[0]; }
  if(!pendingDiscard){ showToast('Î≤ÑÎ¶¥ Ïπ¥ÎìúÎ•º 1Ïû• ÏÑ†ÌÉùÌïòÏÑ∏Ïöî'); return; }
  const fromEl = document.querySelector(`#hand .card[data-id="${pendingDiscard.id}"]`);
  const fromRect = fromEl? fromEl.getBoundingClientRect() : document.getElementById('hand').getBoundingClientRect();
  p.hand = p.hand.filter(c=>c!==pendingDiscard);
  state.discard.push(pendingDiscard); logMsg(`${p.name} Î≤ÑÎ¶º: ${cardText(pendingDiscard)}`);
  const justDiscarded = pendingDiscard;
  pendingDiscard=null; document.getElementById('btnDiscard').disabled=true; clearSelection();
  // Îï°ÌÅê ÏÑ†Ï∞©Ïàú Ï∞Ω Ïò§Ìîà
  state.ty = { open:true, claimant:null, fromPlayerId:p.id, cardId:justDiscarded.id };
  drawUI();
  const topEl = document.querySelector('#discardCards .card');
  if(topEl){ const toRect = topEl.getBoundingClientRect(); flyCard(fromRect, toRect, justDiscarded); }
  // Î¥áÏù¥ Î®ºÏ†Ä Ïô∏Ïπ† Ïàò ÏûàÏúºÎ©¥ Ï¶âÏãú ÏÑ†Ï†ê
  const nextIdx = nextActiveIndex(state.turnIndex);
  const bot = state.players[nextIdx];
  if(bot?.isBot){
    const chk = legalThankYouFor(bot);
    if(chk.allowed){
      claimThankYou(nextIdx);
      // Îï°ÌÅêÎ°ú Í∞ÄÏ†∏Ïò® Ï¶âÏãú ÏÇ¨Ïö© ÏãúÎèÑ
      // Îì±Î°ù Ïö∞ÏÑ† ‚Üí Î∂ôÏù¥Í∏∞
      const combos = kComb(bot.hand,1,5).sort((a,b)=>b.length-a.length);
      for(const cs of combos){ const m=classifyMeld(cs); if(m && cs.some(c=>c.id===state.mustUseThankYouCardId)){ bot.hand = bot.hand.filter(c=>!cs.includes(c)); state.melds.push(m); logMsg(`Bot(Îï°ÌÅê) Îì±Î°ù: ${m.kind.toUpperCase()}`); state.mustUseThankYouCardId=null; break; } }
      if(state.mustUseThankYouCardId){ // ÏïÑÏßÅ ÏÇ¨Ïö© Î™ªÌñàÏúºÎ©¥ Î∂ôÏù¥Í∏∞ ÌÉêÏÉâ
        for(let j=0;j<state.melds.length;j++){ const top = bot.hand.find(c=>c.id===state.mustUseThankYouCardId); if(top && canAttach(top,state.melds[j])){ bot.hand = bot.hand.filter(x=>x!==top); state.melds[j].cards.push(top); state.melds[j].cards=sortByRank(state.melds[j].cards); logMsg('Bot(Îï°ÌÅê) Î∂ôÏù¥Í∏∞'); state.mustUseThankYouCardId=null; break; } }
      }
    }
  }
  if(afterAnyAction(p)) return;
  endTurn(); drawUI(); maybeBotTurn();
}

function reshuffleFromDiscard(){
  if(state.discard.length<2) return; // keep top
  const top = state.discard.pop();
  state.deck = shuffle(state.discard); state.discard=[top];
  showToast('Î≤ÑÎ¶∞ Ìå®Î•º ÏÑûÏñ¥ Îç± Î≥¥Ï∂©');
}

// ====== Bot (human-like delay) ======
function maybeBotTurn(){
  const p=current(); if(!p.isBot || state.phase==='gameover') return;
  const delay = (ms)=>new Promise(res=>setTimeout(res, ms));
  (async()=>{ await delay(300 + Math.random()*500); await botActAsync(delay); })();
}
async function botActAsync(delay){
  const p=current(); if(!p.isBot || p.status!=='active') return;
  if(state.phase==='choose-source'){
    await delay(200+Math.random()*400);
    // Îï°ÌÅê ÏÑ†Ï†ê Í∞ÄÎä• ÏãúÎèÑ(ÏûêÍ∏∞ ÌÑ¥ ÏãúÏûëÏóêÎèÑ Ïó¥Î†§ÏûàÎã§Î©¥)
    if(state.ty.open && !state.ty.claimant){
      const chk = legalThankYouFor(p);
      if(chk.allowed){ claimThankYou(state.turnIndex); drawUI(); return botActAsync(delay); }
    }
    drawFromDeck(); drawUI(); return botActAsync(delay);
  }
  const tryRegister = async () => {
    const combos = kComb(p.hand,1,5).sort((a,b)=>b.length-a.length);
    for(const cs of combos){ const m=classifyMeld(cs); if(m){
      await delay(220+Math.random()*380);
      p.hand = p.hand.filter(c=>!cs.includes(c)); state.melds.push(m);
      logMsg(`Bot Îì±Î°ù: ${m.kind.toUpperCase()} (${pretty(m.cards)})`);
      drawUI(); if(afterAnyAction(p)) return true; return tryRegister();
    }} return false;
  };
  if(await tryRegister()) return;
  for(let i=0;i<p.hand.length;i++){
    const c=p.hand[i];
    for(let j=0;j<state.melds.length;j++){
      if(canAttach(c,state.melds[j])){
        await delay(180+Math.random()*300);
        p.hand.splice(i,1); state.melds[j].cards.push(c); state.melds[j].cards=sortByRank(state.melds[j].cards);
        logMsg(`Bot Î∂ôÏù¥Í∏∞: ${cardText(c)} ‚Üí #${j+1}`);
        drawUI(); if(afterAnyAction(p)) return; i=-1; break;
      }
    }
  }
  await delay(220+Math.random()*380);
  let candIndex=0, bestScore=-1;
  for(let i=0;i<p.hand.length;i++){
    const c=p.hand[i];
    const rv=rankValue(c.rank); const suitScore = p.hand.filter(x=>x.suit===c.suit).length;
    const rankScore = p.hand.filter(x=>x.rank===c.rank).length;
    const score = rv + (1/(suitScore||1))*4 + (1/(rankScore||1))*6;
    if(score>bestScore){bestScore=score; candIndex=i;}
  }
  const dc = p.hand.splice(candIndex,1)[0]; state.discard.push(dc); logMsg(`Bot Î≤ÑÎ¶º: ${cardText(dc)}`);
  // Îï°ÌÅê Ï∞Ω Ïò§Ìîà
  state.ty = { open:true, claimant:null, fromPlayerId:p.id, cardId:dc.id };
  drawUI(); if(afterAnyAction(p)) return; endTurn(); drawUI();
}

// ====== UI ======
function drawUI(){
  state.options.totalSeats = clampSeatCount(state.options.totalSeats ?? MIN_PLAYERS);
  const continueEl = document.getElementById('opt-continue');
  if(continueEl){ continueEl.checked = state.options.continueAfterOut; }
  const seatSelect = document.getElementById('opt-seats');
  if(seatSelect){
    const desired = String(state.options.totalSeats);
    if(seatSelect.value !== desired) seatSelect.value = desired;
    seatSelect.disabled = net.online && !net.isHost;
  }
  const activeTurn = state.players[state.turnIndex];
  const turnBadge = document.getElementById('turnBadge');
  if(turnBadge){
    if(activeTurn){ turnBadge.textContent = `ÌÑ¥: ${activeTurn.name} ¬∑ ${activeTurn.hand.length}Ïû•`; }
    else { turnBadge.textContent = 'ÌÑ¥: -'; }
  }
  const roundInfo = document.getElementById('roundInfo');
  if(roundInfo){ roundInfo.textContent = `R${state.round}${state.phase==='gameover'?' ¬∑ Í≤åÏûÑÎÅù':''}`; }
  const deckCount = document.getElementById('deckCount');
  if(deckCount){ deckCount.textContent = state.deck.length ? `${state.deck.length}Ïû• ÎÇ®Ïùå` : 'Îç± ÎπÑÏóàÏùå'; }

  const seatLayer = document.getElementById('arenaSeats');
  if(seatLayer){
    seatLayer.innerHTML='';
    const total = state.players.length || 1;
    state.players.forEach((p, idx)=>{
      const seat=document.createElement('div');
      seat.className='seat';
      seat.style.setProperty('--angle', `${(360/total)*idx}deg`);
      seat.dataset.turn = String(state.turnIndex===idx);
      seat.dataset.status = p.status;
      seat.dataset.bot = String(p.isBot);
      const nameEl=document.createElement('div');
      nameEl.className='seat-name';
      nameEl.textContent=p.name;
      const meta=document.createElement('div');
      meta.className='seat-meta';
      meta.textContent = p.status==='active'?`${p.hand.length}Ïû• Î≥¥Ïú†`:'OUT';
      seat.appendChild(nameEl);
      seat.appendChild(meta);
      seatLayer.appendChild(seat);
    });
  }

  const dc = document.getElementById('discardCards');
  if(dc){
    dc.innerHTML='';
    const top = state.discard[state.discard.length-1];
    if(top){ const el=cardEl(top,false); el.classList.add('enter'); dc.appendChild(el); }
  }

  const mwrap = document.getElementById('melds');
  if(mwrap){
    mwrap.innerHTML='';
    state.melds.forEach((m,i)=>{
      const d=document.createElement('div'); d.className='meld enter';
      const title=document.createElement('div'); title.className='panel-title';
      title.textContent = `#${i+1} ¬∑ ${m.kind.toUpperCase()} (${m.cards.length})`;
      const row=document.createElement('div'); row.className='cards';
      m.cards.forEach(c=>{ const el=cardEl(c,false); el.classList.add('enter'); row.appendChild(el); });
      d.appendChild(title); d.appendChild(row); mwrap.appendChild(d);
    });
  }

  const handEl = document.getElementById('hand');
  if(handEl){
    handEl.innerHTML='';
    const me = state.players[0];
    if(me){
      me.hand.sort((a,b)=> (a.suit===b.suit? rankValue(a.rank)-rankValue(b.rank) : a.suit.localeCompare(b.suit)));
      me.hand.forEach(c=>{ const el=cardEl(c,true); el.classList.add('enter'); handEl.appendChild(el); });
    }
  }

  const plist=document.getElementById('players');
  if(plist){
    plist.innerHTML='';
    state.players.forEach((p,idx)=>{
      const line=document.createElement('div');
      line.className='player-line';
      line.dataset.turn = String(state.turnIndex===idx);
      line.dataset.status = p.status;
      line.dataset.bot = String(p.isBot);
      const left=document.createElement('div');
      left.className='player-name';
      const nameSpan=document.createElement('span'); nameSpan.textContent=p.name;
      const typeSpan=document.createElement('span'); typeSpan.className='player-type'; typeSpan.textContent = p.isBot?'ü§ñ':'üôÇ';
      left.appendChild(nameSpan); left.appendChild(typeSpan);
      const right=document.createElement('div'); right.innerHTML = `<span class="rankpill">${p.status==='active'?`${p.hand.length}Ïû•`:'OUT'}</span>`;
      line.appendChild(left); line.appendChild(right); plist.appendChild(line);
    });
  }

  const finish=document.getElementById('finish');
  if(finish){
    finish.innerHTML='';
    state.finishOrder.forEach((pid,idx)=>{
      const li=document.createElement('li'); const nm = state.players.find(p=>p.id===pid)?.name||pid; li.textContent = `${idx+1}Îì± ¬∑ ${nm}`; finish.appendChild(li);
    });
  }

  const me = state.players[0];
  const meTurn = me && activeTurn && activeTurn.id==='P1' && me.status==='active' && state.phase!=='gameover';
  document.getElementById('btnDraw').disabled = !meTurn || state.phase!=='choose-source';
  const tyBtn=document.getElementById('btnTY');
  const tyCheck = me ? legalThankYouFor(me) : {allowed:false};
  tyBtn.disabled = !(state.ty.open && (!state.ty.claimant || state.ty.claimant==='P1') && tyCheck.allowed);
  tyBtn.classList.toggle('pulse', !tyBtn.disabled);
}
function cardEl(card, selectable){
  const d=document.createElement('div'); d.className='card'; d.dataset.id=card.id; if(selectable) d.addEventListener('click',()=>toggleSelect(card.id,d));
  const inner=document.createElement('div'); inner.className='inner';
  const rank=document.createElement('div'); rank.className='rank ' + (isRed(card.suit)?'red':'black'); rank.textContent=card.rank;
  const suit=document.createElement('div'); suit.className='suit ' + (isRed(card.suit)?'red':'black'); suit.textContent=card.suit;
  inner.appendChild(rank); inner.appendChild(suit); d.appendChild(inner); return d;
}

const selected = new Set();
function toggleSelect(id, el){ if(selected.has(id)){ selected.delete(id); el.classList.remove('selected'); } else { selected.add(id); el.classList.add('selected'); } updateDiscardButtonState(); }
function selectedFromHand(){ const me=state.players[0]; const ids=[...selected]; const out=[]; ids.forEach(id=>{ const c=me.hand.find(x=>x.id===id); if(c) out.push(c); }); return out; }
function clearSelection(){ selected.clear(); updateDiscardButtonState(); }

// ====== UX helpers ======
function flyCard(fromRect, toRect, card){
  const f=document.createElement('div'); f.className='flycard';
  const r=document.createElement('div'); r.className='flyrank'; r.textContent=card.rank; r.style.color=(isRed(card.suit)?'#e34d5c':'#2b2f3a');
  const s=document.createElement('div'); s.className='flysuit'; s.textContent=card.suit; s.style.color=(isRed(card.suit)?'#e34d5c':'#2b2f3a');
  f.appendChild(r); f.appendChild(s);
  document.body.appendChild(f);
  const startX = fromRect.left + (fromRect.width/2) - 35;
  const startY = fromRect.top + (fromRect.height/2) - 49;
  f.style.transform = `translate(${startX}px, ${startY}px)`; f.style.opacity = .7;
  f.getBoundingClientRect();
  const endX = toRect.left + (toRect.width/2) - 35;
  const endY = toRect.top + (toRect.height/2) - 49;
  requestAnimationFrame(()=>{ f.style.transform = `translate(${endX}px, ${endY}px)`; f.style.opacity=1; });
  setTimeout(()=>{ f.remove(); }, 300);
}
function showToast(message, ms=1200){
  const t = document.getElementById('toast'); if(!t){ console.warn('toast element missing'); return; }
  t.textContent = message; t.style.display = 'block';
  clearTimeout(window.__toastTimer); window.__toastTimer = setTimeout(()=>{ t.style.display='none'; }, ms);
}
function logMsg(msg){ const l=document.getElementById('log'); if(!l){ console.log('[LOG]', msg); return; } const line=document.createElement('div'); line.textContent=msg; l.appendChild(line); l.scrollTop=l.scrollHeight; }
function cardText(c){ return `${c.rank}${c.suit}`; }
function pretty(cards){ return cards.map(cardText).join(' '); }
function updateDiscardButtonState(){ const btn = document.getElementById('btnDiscard'); const meTurn = current().id==='P1' && state.players[0].status==='active' && state.phase!=='gameover'; const one = selectedFromHand().length===1; btn.disabled = !(meTurn && state.phase!=='choose-source' && one && !state.mustUseThankYouCardId); }

// ====== Networking (P2P WebRTC, copy-paste SDP) ======
const net = { role:null, pc:null, dc:null, online:false, isHost:false };
const netBadge = ()=>document.getElementById('netBadge');

async function hostStart(){
  net.role='host'; net.isHost=true; net.pc=new RTCPeerConnection();
  net.dc = net.pc.createDataChannel('hoola');
  wireDataChannel(net.dc);
  const offer = await net.pc.createOffer(); await net.pc.setLocalDescription(offer);
  document.getElementById('sdpOut').value = btoa(JSON.stringify(net.pc.localDescription));
  net.pc.onicecandidate = (e)=>{ if(!e.candidate){ document.getElementById('sdpOut').value = btoa(JSON.stringify(net.pc.localDescription)); }}
}
async function guestStart(){
  net.role='guest'; net.isHost=false; net.pc=new RTCPeerConnection();
  net.pc.ondatachannel = (e)=>{ net.dc=e.channel; wireDataChannel(net.dc); };
  const offerStr = document.getElementById('sdpIn').value.trim(); if(!offerStr) return showToast('Ìò∏Ïä§Ìä∏ ÏΩîÎìúÎ•º Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî');
  const offer = JSON.parse(atob(offerStr));
  await net.pc.setRemoteDescription(offer);
  const answer = await net.pc.createAnswer(); await net.pc.setLocalDescription(answer);
  document.getElementById('sdpOut').value = btoa(JSON.stringify(net.pc.localDescription));
  net.pc.onicecandidate = (e)=>{ if(!e.candidate){ document.getElementById('sdpOut').value = btoa(JSON.stringify(net.pc.localDescription)); }}
}
async function hostApplyAnswer(){ const ansStr = document.getElementById('sdpIn').value.trim(); if(!ansStr) return showToast('Í≤åÏä§Ìä∏ ÏΩîÎìúÎ•º Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî'); const ans = JSON.parse(atob(ansStr)); await net.pc.setRemoteDescription(ans); }
function wireDataChannel(dc){
  dc.onopen=()=>{ net.online=true; netBadge().textContent='Ïò®ÎùºÏù∏'; netBadge().style.background='#eaffea'; netBadge().style.color='#137a13';
    if(net.isHost){ newGame(); sendSnapshot(); }
    else { drawUI(); }
  };
  dc.onmessage=(e)=>{
    const msg = JSON.parse(e.data);
    if(msg.t==='snapshot'){ Object.assign(state, msg.state); drawUI(); return; }
    if(!net.isHost){ return; }
    handleRemoteAction(msg);
  };
}
function sendSnapshot(){ if(net.online && net.dc?.readyState==='open'){ net.dc.send(JSON.stringify({t:'snapshot', state})); }}
function sendAction(a){ if(net.online && net.dc?.readyState==='open'){ net.dc.send(JSON.stringify(a)); }}

function handleRemoteAction(a){
  // Ìò∏Ïä§Ìä∏Í∞Ä ÏÑ†Ï∞©Ïàú ÌåêÏ†ï Î∞è Î™®Îì† Í≤ÄÏ¶ùÏùÑ ÏàòÌñâ
  switch(a.t){
    case 'draw': if(current().id==='P2') { drawFromDeck(); drawUI(); } break;
    case 'thankyou-claim': {
      // ÏõêÍ≤©ÎèÑ ÏÑ†Ï∞©Ïàú
      if(state.ty.open && !state.ty.claimant){
        const idx = state.players.findIndex(p=>p.id==='P2');
        claimThankYou(idx);
        drawUI();
      }
    } break;
    case 'register': {
      if(current().id!=='P2' || state.phase==='gameover') break;
      const p = state.players[1];
      const cards = p.hand.filter(c=>a.ids.includes(c.id));
      if(state.mustUseThankYouCardId && !cards.some(c=>c.id===state.mustUseThankYouCardId)) break;
      const m = classifyMeld(cards);
      if(!m) break; if(a.kind && m.kind!==a.kind) break;
      p.hand = p.hand.filter(c=>!cards.includes(c)); state.melds.push(m); logMsg(`Remote Îì±Î°ù: ${m.kind}`);
      if(state.mustUseThankYouCardId && cards.some(c=>c.id===state.mustUseThankYouCardId)) state.mustUseThankYouCardId=null;
      afterAnyAction(p);
    } break;
    case 'attach': {
      if(current().id!=='P2' || state.phase==='gameover') break;
      const p=state.players[1]; const card=p.hand.find(c=>c.id===a.id); if(!card) break;
      if(state.mustUseThankYouCardId && card.id!==state.mustUseThankYouCardId) break;
      let targetIndex = -1; for(let j=0;j<state.melds.length;j++){ if(canAttach(card, state.melds[j])) { targetIndex=j; break; } }
      if(targetIndex>=0){
        const m=state.melds[targetIndex]; p.hand=p.hand.filter(x=>x!==card); m.cards.push(card); m.cards=sortByRank(m.cards); logMsg('Remote Î∂ôÏù¥Í∏∞');
        if(state.mustUseThankYouCardId===card.id) state.mustUseThankYouCardId=null; afterAnyAction(p);
      }
    } break;
    case 'discard': {
      if(current().id!=='P2' || state.phase==='gameover') break;
      if(state.mustUseThankYouCardId) break;
      const p=state.players[1]; const card=p.hand.find(c=>c.id===a.id); if(!card) break; p.hand=p.hand.filter(x=>x!==card); state.discard.push(card);
      state.ty = { open:true, claimant:null, fromPlayerId:p.id, cardId:card.id };
      endTurn();
    } break;
  }
  sendSnapshot();
}

// ====== Events ======
const elDraw=document.getElementById('btnDraw');
const elTY=document.getElementById('btnTY');
const elRegSet=document.getElementById('btnRegSet');
const elRegRun=document.getElementById('btnRegRun');
const elAttach=document.getElementById('btnAttach');
const elPendDiscard=document.getElementById('btnDiscard');
const elReset=document.getElementById('btnReset');

elDraw.onclick=()=>{ if(net.online && !net.isHost && current().id==='P2') sendAction({t:'draw'}); else { drawFromDeck(); sendSnapshot(); } };
elTY.onclick=()=>{
  if(net.online && !net.isHost){ sendAction({t:'thankyou-claim'}); }
  else { takeThankYou(); sendSnapshot(); }
};
elRegSet.onclick=()=>{ const ids = selectedFromHand().map(c=>c.id); if(net.online && !net.isHost && current().id==='P2') sendAction({t:'register', kind:'set', ids}); else { registerSelected('set'); sendSnapshot(); } };
elRegRun.onclick=()=>{ const ids = selectedFromHand().map(c=>c.id); if(net.online && !net.isHost && current().id==='P2') sendAction({t:'register', kind:'run', ids}); else { registerSelected('run'); sendSnapshot(); } };
elAttach.onclick=()=>{ const sel = selectedFromHand(); if(sel.length!==1){ attachSelected(); sendSnapshot(); return; } const id = sel[0].id; if(net.online && !net.isHost && current().id==='P2') sendAction({t:'attach', id}); else { attachSelected(); sendSnapshot(); } };

document.getElementById('hand').addEventListener('dblclick', ()=>{ setDiscard(); });
elPendDiscard.onclick=()=>{
  if(net.online && !net.isHost && current().id==='P2'){
    const sel = selectedFromHand(); if(sel.length===1) sendAction({t:'discard', id: sel[0].id});
  } else { commitDiscard(); sendSnapshot(); }
};

document.getElementById('opt-continue').addEventListener('change', (e)=>{ state.options.continueAfterOut = e.target.checked; sendSnapshot(); });
document.getElementById('opt-seats').addEventListener('change', (e)=>{
  const next = clampSeatCount(e.target.value);
  if(state.options.totalSeats===next){ e.target.value = String(next); return; }
  state.options.totalSeats = next;
  showToast(`${next}Ïù∏ ÌÖåÏù¥Î∏îÎ°ú ÏÉà Í≤åÏûÑ!`);
  newGame();
  sendSnapshot();
});

elReset.onclick=()=>{ newGame(); sendSnapshot(); };

document.getElementById('btnHost').onclick=()=>hostStart();
document.getElementById('btnJoin').onclick=()=>guestStart();
document.getElementById('btnApply').onclick=()=>hostApplyAnswer();

// ====== Unit Tests (lightweight) ======
function runUnitTests(){
  const results=[]; const rec=(name,ok,detail='')=>{ results.push({name,ok,detail}); (ok?console.log:console.error)(ok?`PASS: ${name}`:`FAIL: ${name} ‚Äî ${detail}`); };
  try{ rec('isSet valid 5x3', isSet([{rank:'5',suit:'‚ô£'},{rank:'5',suit:'‚ô•'},{rank:'5',suit:'‚ô¶'}])); }catch(e){ rec('isSet valid 5x3', false, e.message); }
  try{ rec('isSet invalid len<3', !isSet([{rank:'5',suit:'‚ô£'},{rank:'5',suit:'‚ô•'}])); }catch(e){ rec('isSet invalid len<3', false, e.message); }
  try{ rec('isSet invalid mismatch', !isSet([{rank:'5',suit:'‚ô£'},{rank:'5',suit:'‚ô•'},{rank:'6',suit:'‚ô¶'}])); }catch(e){ rec('isSet invalid mismatch', false, e.message); }
  try{ rec('isRun 5-6-7 ‚ô•', isRun([{rank:'5',suit:'‚ô•'},{rank:'6',suit:'‚ô•'},{rank:'7',suit:'‚ô•'}])); }catch(e){ rec('isRun 5-6-7 ‚ô•', false, e.message); }
  try{ rec('isRun A-2-3 ‚ô£ (low ace)', isRun([{rank:'A',suit:'‚ô£'},{rank:'2',suit:'‚ô£'},{rank:'3',suit:'‚ô£'}])); }catch(e){ rec('isRun A-2-3 low', false, e.message); }
  try{ rec('isRun Q-K-A ‚ô¶ (high ace)', isRun([{rank:'Q',suit:'‚ô¶'},{rank:'K',suit:'‚ô¶'},{rank:'A',suit:'‚ô¶'}])); }catch(e){ rec('isRun Q-K-A high', false, e.message); }
  try{ rec('isRun no wrap K-A-2 ‚ô†', !isRun([{rank:'K',suit:'‚ô†'},{rank:'A',suit:'‚ô†'},{rank:'2',suit:'‚ô†'}])); }catch(e){ rec('isRun no wrap', false, e.message); }
  try{ const m = classifyMeld([{rank:'7',suit:'‚ô£'}]); rec('classify single 7 ‚Üí seven', m && m.kind==='seven'); }catch(e){ rec('classify seven', false, e.message); }
  try{ const setM = {kind:'set', cards:[{rank:'5',suit:'‚ô•'},{rank:'5',suit:'‚ô¶'},{rank:'5',suit:'‚ô†'}]}; rec('attach 5‚ô£ to set', canAttach({rank:'5',suit:'‚ô£'}, setM)); }catch(e){ rec('attach to set', false, e.message); }
  try{ const runM = {kind:'run', cards: sortByRank([{rank:'2',suit:'‚ô•'},{rank:'3',suit:'‚ô•'},{rank:'4',suit:'‚ô•'}])}; rec('attach 5‚ô• to run end', canAttach({rank:'5',suit:'‚ô•'}, runM)); }catch(e){ rec('attach to run end 5', false, e.message); }
  try{ const runM2 = {kind:'run', cards: sortByRank([{rank:'3',suit:'‚ô•'},{rank:'4',suit:'‚ô•'},{rank:'5',suit:'‚ô•'}])}; rec('attach 2‚ô• to run start', canAttach({rank:'2',suit:'‚ô•'}, runM2)); }catch(e){ rec('attach to run start 2', false, e.message); }
  try{ const runM3 = {kind:'run', cards: sortByRank([{rank:'3',suit:'‚ô•'},{rank:'4',suit:'‚ô•'},{rank:'5',suit:'‚ô•'}])}; rec('attach 6‚ô• to run end', canAttach({rank:'6',suit:'‚ô•'}, runM3)); }catch(e){ rec('attach to run end 6', false, e.message); }
  try{ const runM4 = {kind:'run', cards: sortByRank([{rank:'3',suit:'‚ô•'},{rank:'4',suit:'‚ô•'},{rank:'5',suit:'‚ô•'}])}; rec('attach 4‚ô• (middle) not allowed', !canAttach({rank:'4',suit:'‚ô•'}, runM4)); }catch(e){ rec('attach to run middle 4', false, e.message); }
  try{ const sevenM = {kind:'seven', cards:[{rank:'7',suit:'‚ô£'}]}; rec('cannot attach to solo seven', !canAttach({rank:'6',suit:'‚ô£'}, sevenM)); }catch(e){ rec('seven attach rule', false, e.message); }
  // ThankYou race: open & claimant null, two claim attempts -> first wins
  try{
    const tmp=JSON.parse(JSON.stringify(state));
    state.players=[{id:'P1',name:'A',isBot:false,hand:[],status:'active'},{id:'P2',name:'B',isBot:false,hand:[],status:'active'}];
    state.discard=[{id:'X',rank:'7',suit:'‚ô£'}];
    state.melds=[]; state.phase='choose-source';
    state.ty={open:true, claimant:null, fromPlayerId:'P2', cardId:'X'};
    // Give P1 a helping card to register 7 solo
    const preLen = state.players[0].hand.length;
    const c1 = claimThankYou(0);
    const c2 = claimThankYou(1);
    rec('thankyou first-come wins', c1===true && c2===false && state.players[0].hand.length===preLen+1);
    Object.assign(state,tmp);
  }catch(e){ rec('thankyou race rule', false, e.message); }
  const ok = results.filter(r=>r.ok).length; const total = results.length; logMsg(`ÌÖåÏä§Ìä∏: ${ok}/${total} ÏÑ±Í≥µ`); results.filter(r=>!r.ok).forEach(r=>logMsg(`‚ùå ${r.name} ${r.detail?'- '+r.detail:''}`));
}

runUnitTests();

// boot
newGame();
</script>
</body>
</html>
